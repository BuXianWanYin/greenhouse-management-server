# 种植计划管理模块完善说明

## 一、现有表结构分析

### 1. agriculture_crop_batch（种植批次表）

**需要删除的字段：**
- `germplasm_id` - 鱼种质ID（不需要区分鱼和菜）
- `vegetable_id` - 菜种质ID（统一使用class_id）
- `fish_area` - 养殖面积（不需要鱼的部分）
- `contract_addr` - 区块链合约地址（不需要区块链）

**需要新增的字段：**
- `class_id` - 统一种质ID（替代germplasm_id和vegetable_id）
- `plan_year` - 计划年份
- `season_type` - 季节类型
- `rotation_plan_id` - 轮作计划ID
- `planting_density` - 种植密度
- `expected_harvest_time` - 预期收获时间
- `current_growth_stage` - 当前生长阶段
- `growth_stage_start_time` - 当前生长阶段开始时间
- `total_growth_days` - 总生长天数
- `actual_harvest_time` - 实际收获时间

## 二、新建表说明

### 1. agriculture_annual_plan（年度种植规划表）
**功能：** 管理年度种植计划
**主要字段：**
- `plan_year` - 计划年份
- `plan_name` - 计划名称
- `pasture_id` - 温室ID（NULL表示全温室）
- `plan_type` - 计划类型（年度计划/季节性计划）
- `plan_status` - 计划状态（草稿/已发布/执行中/已完成/已取消）
- `start_date` / `end_date` - 计划时间范围
- `total_area` - 计划总面积

### 2. agriculture_rotation_plan（轮作计划表）
**功能：** 管理轮作计划
**主要字段：**
- `rotation_name` - 轮作计划名称
- `plan_year` - 计划年份
- `pasture_id` - 温室ID
- `rotation_cycle` - 轮作周期（年）
- `rotation_status` - 状态

### 3. agriculture_rotation_detail（轮作计划明细表）
**功能：** 记录轮作计划中的具体作物顺序
**主要字段：**
- `rotation_id` - 轮作计划ID
- `class_id` - 种质ID
- `rotation_order` - 轮作顺序
- `season_type` - 季节类型
- `planting_area` - 种植面积
- `planting_density` - 种植密度
- `expected_start_date` / `expected_end_date` - 预期时间

### 4. agriculture_growth_stage（生长阶段表）
**功能：** 跟踪作物生长阶段
**主要字段：**
- `batch_id` - 批次ID
- `stage_type` - 生长阶段类型（幼苗期/生长期/开花期/结果期/成熟期）
- `stage_order` - 阶段顺序
- `expected_start_date` / `expected_end_date` - 预期时间
- `actual_start_date` / `actual_end_date` - 实际时间
- `stage_status` - 阶段状态

### 5. agriculture_growth_node（生长关键节点表）
**功能：** 管理关键节点（播种、移栽、开花、结果、收获）
**主要字段：**
- `batch_id` - 批次ID
- `node_type` - 节点类型（播种/移栽/开花/结果/收获）
- `expected_date` - 预期日期
- `actual_date` - 实际日期
- `remind_days` - 提前提醒天数
- `remind_status` - 提醒状态
- `node_images` / `node_videos` - 节点图片/视频

### 6. agriculture_plan_batch（年度计划批次关联表）
**功能：** 关联年度计划和批次
**主要字段：**
- `plan_id` - 年度计划ID
- `batch_id` - 批次ID

## 三、字段说明

### 季节类型（season_type）
- `spring` - 春季
- `summer` - 夏季
- `autumn` - 秋季
- `winter` - 冬季

### 生长阶段类型（stage_type / current_growth_stage）
- `seedling` - 幼苗期
- `growth` - 生长期
- `flowering` - 开花期
- `fruiting` - 结果期
- `mature` - 成熟期

### 节点类型（node_type）
- `sowing` - 播种
- `transplanting` - 移栽
- `flowering` - 开花
- `fruiting` - 结果
- `harvest` - 收获

### 计划状态（plan_status）
- `0` - 草稿
- `1` - 已发布
- `2` - 执行中
- `3` - 已完成
- `4` - 已取消

### 阶段状态（stage_status / node_status）
- `0` - 未开始
- `1` - 进行中
- `2` - 已完成

### 提醒状态（remind_status）
- `0` - 未提醒
- `1` - 已提醒
- `2` - 已完成

## 四、接下来的完善步骤

### 第一步：执行SQL脚本
1. 执行 `种植计划管理模块完善方案.sql` 中的所有SQL语句
2. 确认表结构创建成功
3. 确认字段修改成功

### 第二步：使用若依代码生成器
1. 为以下新表生成代码：
   - `agriculture_annual_plan` - 年度种植规划
   - `agriculture_rotation_plan` - 轮作计划
   - `agriculture_rotation_detail` - 轮作计划明细
   - `agriculture_growth_stage` - 生长阶段
   - `agriculture_growth_node` - 生长关键节点
   - `agriculture_plan_batch` - 年度计划批次关联

2. 修改现有表 `agriculture_crop_batch` 的实体类：
   - 删除不需要的字段（germplasm_id, vegetable_id, fish_area, contract_addr）
   - 添加新字段（class_id, plan_year, season_type等）

### 第三步：业务逻辑完善（代码生成后找我）

#### 3.1 年度种植规划功能
- **年度计划制定**
  - 创建年度计划
  - 设置计划年份、名称、时间范围
  - 关联温室或全温室
  - 设置计划总面积

- **季节性安排**
  - 在年度计划中按季节规划
  - 关联批次到不同季节
  - 季节性统计和展示

#### 3.2 轮作计划功能
- **轮作计划制定**
  - 创建轮作计划
  - 设置轮作周期
  - 添加轮作明细（作物顺序、季节、面积、密度）
  - 关联到批次

#### 3.3 种植密度规划
- 在批次中设置种植密度
- 在轮作计划明细中设置种植密度
- 密度统计和分析

#### 3.4 种植周期管理
- **生长周期跟踪**
  - 自动创建生长阶段记录
  - 跟踪各阶段的时间进度
  - 更新当前生长阶段

- **关键节点提醒**
  - 根据预期日期自动创建节点
  - 提前N天提醒（可配置）
  - 节点完成确认
  - 提醒通知推送

- **生长阶段状态管理**
  - 阶段开始/结束时间记录
  - 阶段状态更新
  - 阶段进度统计

- **预期收获时间预测**
  - 根据种质信息和历史数据预测
  - 根据当前生长阶段调整预测
  - 收获时间提醒

### 第四步：接口开发（代码生成后找我）

需要开发的接口：

1. **年度计划管理**
   - 创建年度计划
   - 查询年度计划列表
   - 更新年度计划
   - 删除年度计划
   - 发布年度计划
   - 关联批次到计划

2. **轮作计划管理**
   - 创建轮作计划
   - 查询轮作计划列表
   - 更新轮作计划
   - 删除轮作计划
   - 添加轮作明细
   - 更新轮作明细
   - 删除轮作明细

3. **生长阶段管理**
   - 创建生长阶段
   - 查询批次生长阶段列表
   - 更新生长阶段状态
   - 自动创建生长阶段（根据批次开始时间）

4. **关键节点管理**
   - 创建关键节点
   - 查询批次关键节点列表
   - 更新节点状态
   - 节点完成确认
   - 查询待提醒节点列表
   - 自动创建关键节点（根据批次和种质信息）

5. **批次管理增强**
   - 更新批次时自动更新生长阶段
   - 更新批次时自动更新关键节点
   - 批次状态统计
   - 批次进度查询

### 第五步：定时任务开发（代码生成后找我）

1. **节点提醒定时任务**
   - 每天检查待提醒的节点
   - 提前N天发送提醒通知
   - 更新提醒状态

2. **生长阶段自动更新**
   - 检查批次当前生长阶段
   - 根据时间自动更新阶段状态
   - 自动创建下一阶段记录

3. **收获时间预测更新**
   - 根据当前生长阶段重新计算预期收获时间
   - 更新批次预期收获时间

## 五、注意事项

1. **数据迁移**
   - 如果现有数据中有germplasm_id或vegetable_id，需要迁移到class_id
   - 建议先备份数据再执行删除字段操作

2. **字段统一**
   - 所有种质相关字段统一使用class_id
   - 删除所有与鱼相关的字段和逻辑

3. **状态管理**
   - 注意各种状态的枚举值定义
   - 建议在字典表中配置状态选项

4. **时间字段**
   - 注意区分DATE和DATETIME类型
   - 预期时间使用DATE，实际时间记录使用DATETIME

5. **关联关系**
   - 年度计划可以关联多个批次
   - 批次可以关联一个轮作计划
   - 批次可以有多个生长阶段
   - 批次可以有多个关键节点

## 六、后续优化建议

1. **数据统计**
   - 年度计划执行情况统计
   - 轮作计划执行情况统计
   - 生长阶段进度统计
   - 关键节点完成率统计

2. **报表功能**
   - 年度计划报表
   - 轮作计划报表
   - 生长周期报表
   - 节点完成情况报表

3. **预警功能**
   - 节点逾期预警
   - 生长阶段异常预警
   - 收获时间临近预警

